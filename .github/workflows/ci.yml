name: CI

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - '*.md'
      - 'docs/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-latest, windows-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Swift (Ubuntu)
      if: matrix.os == 'ubuntu-22.04'
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "6.2.1"
    
    - name: Setup Swift (macOS)
      if: matrix.os == 'macos-latest'
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "6.2.1"
    
    - name: Setup Swift (Windows)
      if: matrix.os == 'windows-latest'
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "6.2.1"
    
    - name: Install SDL3 (Ubuntu)
      if: matrix.os == 'ubuntu-22.04'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libfreetype6-dev libfontconfig1-dev libx11-dev libxext-dev libxrender-dev libxcursor-dev libxfixes-dev libxinerama-dev libxi-dev libxrandr-dev libxss-dev libxtst-dev libgl1-mesa-dev libegl1-mesa-dev libwayland-dev libwayland-bin libgtk-3-dev libgdk-pixbuf2.0-dev libdbus-1-dev libpipewire-0.3-dev libpulse-dev libasound2-dev git
        # Build SDL3 from source
        cd /tmp
        git clone --depth 1 https://github.com/libsdl-org/SDL.git sdl3-build
        cd sdl3-build
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DSDL_SHARED=ON -DSDL_STATIC=OFF -DSDL_TESTS=OFF
        cmake --build . -j$(nproc)
        sudo cmake --install .
        # Build SDL3_ttf from source
        cd /tmp
        git clone --depth 1 https://github.com/libsdl-org/SDL_ttf.git sdl3-ttf-build
        cd sdl3-ttf-build
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DSDL3TTF_SHARED=ON -DSDL3TTF_STATIC=OFF
        cmake --build . -j$(nproc)
        sudo cmake --install .
        # Verify libraries are installed
        ls -la /usr/local/lib/libSDL3* || echo "SDL3 libraries not found in /usr/local/lib"
        sudo ldconfig
    
    - name: Install SDL3 (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install sdl3 sdl3_ttf
    
    - name: Build Release (Ubuntu)
      if: matrix.os == 'ubuntu-22.04'
      env:
        LIBRARY_PATH: /usr/local/lib
        LD_LIBRARY_PATH: /usr/local/lib
        PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
      run: |
        swift build -c release
    
    - name: Build Release (macOS)
      if: matrix.os == 'macos-latest'
      env:
        LIBRARY_PATH: /opt/homebrew/lib:/usr/local/lib
      run: |
        swift build -c release
    
    - name: Setup MSBuild (Windows)
      if: matrix.os == 'windows-latest'
      uses: microsoft/setup-msbuild@v1.3.1
    
    - name: Build SDL3 Static (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        # Install CMake if not available
        if (-not (Get-Command cmake -ErrorAction SilentlyContinue)) {
          Write-Host "CMake not found, installing via winget..."
          winget install --id Kitware.CMake -e --silent --accept-package-agreements --accept-source-agreements
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        }
        # Build SDL3 as static library
        cd $env:TEMP
        git clone --depth 1 https://github.com/libsdl-org/SDL.git sdl3-static-build
        cd sdl3-static-build
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DSDL_SHARED=OFF -DSDL_STATIC=ON -DSDL_TESTS=OFF
        cmake --build . --config Release
        # Install SDL3 to a local directory (required for SDL3Config.cmake to work properly)
        $sdl3InstallPath = "$env:TEMP\sdl3-static"
        New-Item -ItemType Directory -Force -Path $sdl3InstallPath | Out-Null
        cmake --install . --config Release --prefix $sdl3InstallPath
        if (-not $?) {
          Write-Host "Warning: SDL3 install failed, trying to find library in build output"
        }
        # Try to find the library (prefer install, then build output)
        # Exclude test, ttf, and other sub-libraries - we want the main SDL3 static library
        $sdl3Lib = $null
        if (Test-Path "$sdl3InstallPath\lib") {
          $sdl3Lib = Get-ChildItem "$sdl3InstallPath\lib\*.lib" -ErrorAction SilentlyContinue | Where-Object { 
            $_.Name -match "^SDL3" -and 
            $_.Name -notmatch "SDL3_ttf" -and 
            $_.Name -notmatch "SDL3_test" -and 
            $_.Name -notmatch "\.dll\.lib$" -and
            ($_.Name -match "^SDL3-static\.lib$" -or $_.Name -match "^SDL3\.lib$" -or $_.Name -match "^SDL3-staticd\.lib$")
          } | Select-Object -First 1
        }
        # If not found in install, try build output
        if (-not $sdl3Lib) {
          $buildOutputDirs = @("Release", "Release\lib", "lib", ".")
          foreach ($dir in $buildOutputDirs) {
            $searchPath = Join-Path $PWD $dir
            if (Test-Path $searchPath) {
              $found = Get-ChildItem "$searchPath\*.lib" -ErrorAction SilentlyContinue | Where-Object { 
                $_.Name -match "^SDL3" -and 
                $_.Name -notmatch "SDL3_ttf" -and 
                $_.Name -notmatch "SDL3_test" -and 
                $_.Name -notmatch "\.dll\.lib$" -and
                ($_.Name -match "^SDL3-static\.lib$" -or $_.Name -match "^SDL3\.lib$" -or $_.Name -match "^SDL3-staticd\.lib$")
              } | Select-Object -First 1
              if ($found) {
                $sdl3Lib = $found
                Write-Host "Found SDL3 library in build output: $($found.FullName)"
                break
              }
            }
          }
        }
        # Copy to project root with standard name
        if ($sdl3Lib) {
          Copy-Item $sdl3Lib.FullName "$env:GITHUB_WORKSPACE\SDL3.lib" -Force
          Write-Host "Copied and renamed $($sdl3Lib.Name) to SDL3.lib"
        } else {
          Write-Host "Error: SDL3 static library not found after build"
          Write-Host "Searching in: $PWD"
          Get-ChildItem -Recurse -Filter "*.lib" | Select-Object FullName | ForEach-Object { Write-Host "Found lib: $($_.FullName)" }
          exit 1
        }
        # Copy headers (prefer install path, then source directory)
        New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\sdl3-headers" | Out-Null
        $headerSource = "$sdl3InstallPath\include\SDL3"
        if (-not (Test-Path $headerSource)) {
          # Try source directory
          $headerSource = "$env:TEMP\sdl3-static-build\include\SDL3"
        }
        if (Test-Path $headerSource) {
          Copy-Item "$headerSource\*" "$env:GITHUB_WORKSPACE\sdl3-headers\" -Recurse -ErrorAction SilentlyContinue
          Write-Host "Copied SDL3 headers from $headerSource"
        } else {
          Write-Host "Warning: SDL3 headers not found"
        }
        Write-Host "SDL3 static library built and installed to $sdl3InstallPath"
    
    - name: Build SDL3_ttf Static (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        # Build SDL3_ttf as static library
        cd $env:TEMP
        git clone --depth 1 https://github.com/libsdl-org/SDL_ttf.git sdl3-ttf-static-build
        cd sdl3-ttf-static-build
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        # Find SDL3 installation (use the install path where SDL3Config.cmake should be properly configured)
        $sdl3InstallPath = "$env:TEMP\sdl3-static"
        # Verify SDL3Config.cmake exists and check its location
        $sdl3ConfigPath = "$sdl3InstallPath\lib\cmake\SDL3\SDL3Config.cmake"
        if (-not (Test-Path $sdl3ConfigPath)) {
          # Try alternative location
          $sdl3ConfigPath = "$sdl3InstallPath\cmake\SDL3\SDL3Config.cmake"
          if (-not (Test-Path $sdl3ConfigPath)) {
            # Try build directory as fallback
            $sdl3ConfigPath = "$env:TEMP\sdl3-static-build\build\SDL3Config.cmake"
            if (Test-Path $sdl3ConfigPath) {
              $sdl3InstallPath = "$env:TEMP\sdl3-static-build\build"
            } else {
              Write-Host "Error: SDL3Config.cmake not found in expected locations"
              Write-Host "Checking install directory structure:"
              Get-ChildItem -Recurse -Path $sdl3InstallPath -Filter "*.cmake" | Select-Object FullName | ForEach-Object { Write-Host "Found: $($_.FullName)" }
              exit 1
            }
          }
        }
        Write-Host "Using SDL3_DIR: $sdl3InstallPath"
        Write-Host "SDL3Config.cmake found at: $sdl3ConfigPath"
        # Find SDL3 library and include paths to help CMake
        # Exclude test, ttf, and other sub-libraries - we want the main SDL3 static library
        $sdl3LibPath = Get-ChildItem "$env:TEMP\sdl3-static\lib\*.lib" -ErrorAction SilentlyContinue | Where-Object { 
          $_.Name -match "^SDL3" -and 
          $_.Name -notmatch "SDL3_ttf" -and 
          $_.Name -notmatch "SDL3_test" -and 
          $_.Name -notmatch "\.dll\.lib$" -and
          ($_.Name -match "^SDL3-static\.lib$" -or $_.Name -match "^SDL3\.lib$" -or $_.Name -match "^SDL3-staticd\.lib$")
        } | Select-Object -First 1
        if (-not $sdl3LibPath) {
          # Try build directory - look in Release subdirectory
          $buildDirs = @("Release", "Release\lib", "lib", ".")
          foreach ($dir in $buildDirs) {
            $searchPath = Join-Path "$env:TEMP\sdl3-static-build\build" $dir
            if (Test-Path $searchPath) {
              $found = Get-ChildItem "$searchPath\*.lib" -ErrorAction SilentlyContinue | Where-Object { 
                $_.Name -match "^SDL3" -and 
                $_.Name -notmatch "SDL3_ttf" -and 
                $_.Name -notmatch "SDL3_test" -and 
                $_.Name -notmatch "\.dll\.lib$" -and
                ($_.Name -match "^SDL3-static\.lib$" -or $_.Name -match "^SDL3\.lib$" -or $_.Name -match "^SDL3-staticd\.lib$")
              } | Select-Object -First 1
              if ($found) {
                $sdl3LibPath = $found
                # Copy to install lib directory so SDL3Config.cmake can find it
                $installLibDir = "$env:TEMP\sdl3-static\lib"
                if (-not (Test-Path $installLibDir)) {
                  New-Item -ItemType Directory -Force -Path $installLibDir | Out-Null
                }
                Copy-Item $found.FullName "$installLibDir\$($found.Name)" -Force
                Write-Host "Copied library to install directory: $installLibDir\$($found.Name)"
                break
              }
            }
          }
        }
        $sdl3IncludePath = "$env:TEMP\sdl3-static\include"
        if (-not (Test-Path $sdl3IncludePath)) {
          $sdl3IncludePath = "$env:TEMP\sdl3-static-build\include"
        }
        if ($sdl3LibPath) {
          Write-Host "SDL3 library: $($sdl3LibPath.FullName)"
        } else {
          Write-Host "Warning: SDL3 library not found, SDL3_ttf build may fail"
        }
        Write-Host "SDL3 include: $sdl3IncludePath"
        # List all libraries found for debugging
        Write-Host "All SDL3 libraries in install lib:"
        if (Test-Path "$env:TEMP\sdl3-static\lib") {
          Get-ChildItem "$env:TEMP\sdl3-static\lib\*.lib" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  $($_.Name)" }
        }
        # Ensure we're using the install path (not build path) for SDL3_DIR
        # SDL3Config.cmake in the install directory should work better
        $sdl3ConfigInInstall = "$env:TEMP\sdl3-static\lib\cmake\SDL3\SDL3Config.cmake"
        if (Test-Path $sdl3ConfigInInstall) {
          $sdl3InstallPath = "$env:TEMP\sdl3-static"
          Write-Host "Using installed SDL3Config.cmake instead of build directory"
        }
        # SDL3_ttf will find freetype automatically or we can let CMake download it
        # Use both SDL3_DIR and manually set library/include paths to help CMake find SDL3
        # Also try setting SDL3_ROOT as an alternative
        $cmakeArgs = @(
          "..",
          "-G", "Visual Studio 17 2022",
          "-A", "x64",
          "-DCMAKE_BUILD_TYPE=Release",
          "-DSDL3TTF_SHARED=OFF",
          "-DSDL3TTF_STATIC=ON",
          "-DSDL3_DIR=$sdl3InstallPath",
          "-DSDL3_ROOT=$sdl3InstallPath",
          "-DCMAKE_PREFIX_PATH=$sdl3InstallPath"
        )
        if ($sdl3LibPath) {
          # Use the library path from install directory if available
          $installLibPath = "$env:TEMP\sdl3-static\lib\$($sdl3LibPath.Name)"
          if (Test-Path $installLibPath) {
            $cmakeArgs += "-DSDL3_LIBRARY=$installLibPath"
            $cmakeArgs += "-DSDL3_LIBRARY_DIR=$env:TEMP\sdl3-static\lib"
          } else {
            $cmakeArgs += "-DSDL3_LIBRARY=$($sdl3LibPath.FullName)"
            $sdl3LibDir = Split-Path -Parent $sdl3LibPath.FullName
            $cmakeArgs += "-DSDL3_LIBRARY_DIR=$sdl3LibDir"
          }
        }
        if (Test-Path $sdl3IncludePath) {
          $cmakeArgs += "-DSDL3_INCLUDE_DIR=$sdl3IncludePath"
        }
        & cmake $cmakeArgs
        cmake --build . --config Release
        # Try to find the library in build output (Visual Studio puts it in Release/ subdirectory)
        $sdl3ttfLib = $null
        # First, try to find in the build output directory
        $buildOutputDirs = @("Release", "Release\lib", "lib", ".")
        foreach ($dir in $buildOutputDirs) {
          $searchPath = Join-Path $PWD $dir
          if (Test-Path $searchPath) {
            $found = Get-ChildItem "$searchPath\*.lib" -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "SDL3_ttf" -and $_.Name -notmatch "\.dll\.lib$" } | Select-Object -First 1
            if ($found) {
              $sdl3ttfLib = $found
              Write-Host "Found SDL3_ttf library in build output: $($found.FullName)"
              break
            }
          }
        }
        # If not found in build output, try install (but don't fail if it fails)
        if (-not $sdl3ttfLib) {
          $sdl3ttfInstallPath = "$env:TEMP\sdl3-ttf-static"
          New-Item -ItemType Directory -Force -Path $sdl3ttfInstallPath | Out-Null
          cmake --install . --config Release --prefix $sdl3ttfInstallPath 2>&1 | Out-Null
          if (Test-Path "$sdl3ttfInstallPath\lib") {
            $sdl3ttfLib = Get-ChildItem "$sdl3ttfInstallPath\lib\*.lib" -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "SDL3_ttf" } | Select-Object -First 1
          }
        }
        # Copy to project root with standard name
        if ($sdl3ttfLib) {
          Copy-Item $sdl3ttfLib.FullName "$env:GITHUB_WORKSPACE\SDL3_ttf.lib" -Force
          Write-Host "Copied and renamed $($sdl3ttfLib.Name) to SDL3_ttf.lib"
        } else {
          Write-Host "Error: SDL3_ttf static library not found after build"
          Write-Host "Searching in: $PWD"
          Get-ChildItem -Recurse -Filter "*.lib" | Select-Object FullName | ForEach-Object { Write-Host "Found lib: $($_.FullName)" }
          exit 1
        }
        Write-Host "SDL3_ttf static library built and installed"
    
    - name: Build Release (Windows)
      if: matrix.os == 'windows-latest'
      shell: cmd
      run: |
        swift build -c release
    
    - name: Bundle Windows Release (Windows)
      if: matrix.os == 'windows-latest' && github.event_name == 'push'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release-bundle | Out-Null
        Copy-Item .build\release\Tetrix.exe release-bundle\
        # SDL3 and SDL3_ttf are now statically linked, so no DLLs needed
        # Only copy Swift runtime DLLs (these cannot be statically linked)
        $swiftDlls = @("swiftCore.dll", "swiftWinSDK.dll", "FoundationEssentials.dll", "swiftCRT.dll")
        $swiftPath = "$env:LOCALAPPDATA\Programs\Swift"
        foreach ($dll in $swiftDlls) {
          $found = Get-ChildItem -Path $swiftPath -Filter $dll -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($found) {
            Copy-Item $found.FullName release-bundle\
            Write-Host "Copied $dll from $($found.FullName)"
          } else {
            Write-Host "Warning: $dll not found"
          }
        }
        Compress-Archive -Path release-bundle\* -DestinationPath Tetrix-windows.zip -Force
    
    - name: Rename macOS Binary
      if: matrix.os == 'macos-latest' && github.event_name == 'push'
      run: |
        if [ -f .build/release/Tetrix ]; then
          mv .build/release/Tetrix .build/release/TetrixDarwin
          echo "Renamed Tetrix to TetrixDarwin"
        else
          echo "Error: .build/release/Tetrix not found"
          ls -la .build/release/ || echo "Release directory does not exist"
          exit 1
        fi
    
    - name: Delete Existing Release (Linux - first platform)
      if: matrix.os == 'ubuntu-22.04' && github.event_name == 'push'
      run: |
        gh release delete latest --yes || echo "Release 'latest' does not exist, will create new one"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create/Update Release and Upload Asset (Linux)
      if: matrix.os == 'ubuntu-22.04' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        target_commitish: ${{ github.sha }}
        name: Latest Build
        draft: false
        prerelease: false
        generate_release_notes: true
        files: .build/release/Tetrix
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Verify macOS Binary Before Upload
      if: matrix.os == 'macos-latest' && github.event_name == 'push'
      run: |
        if [ ! -f .build/release/TetrixDarwin ]; then
          echo "Error: TetrixDarwin binary not found after rename"
          ls -la .build/release/ || echo "Release directory does not exist"
          exit 1
        fi
        echo "TetrixDarwin binary found, size: $(stat -f%z .build/release/TetrixDarwin 2>/dev/null || stat -c%s .build/release/TetrixDarwin 2>/dev/null || echo 'unknown') bytes"
    
    - name: Create/Update Release and Upload Asset (macOS)
      if: matrix.os == 'macos-latest' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        target_commitish: ${{ github.sha }}
        name: Latest Build
        draft: false
        prerelease: false
        generate_release_notes: true
        files: .build/release/TetrixDarwin
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create/Update Release and Upload Asset (Windows)
      if: matrix.os == 'windows-latest' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        target_commitish: ${{ github.sha }}
        name: Latest Build
        draft: false
        prerelease: false
        generate_release_notes: true
        files: Tetrix-windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
