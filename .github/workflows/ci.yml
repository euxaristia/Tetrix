name: CI

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - '*.md'
      - 'docs/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-latest, windows-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Swift (Ubuntu)
      if: matrix.os == 'ubuntu-22.04'
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "6.2.1"
    
    - name: Setup Swift (macOS)
      if: matrix.os == 'macos-latest'
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "6.2.1"
    
    - name: Setup Swift (Windows)
      if: matrix.os == 'windows-latest'
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "6.2.1"
    
    - name: Install SDL3 (Ubuntu)
      if: matrix.os == 'ubuntu-22.04'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libfreetype6-dev libfontconfig1-dev libx11-dev libxext-dev libxrender-dev libxcursor-dev libxfixes-dev libxinerama-dev libxi-dev libxrandr-dev libxss-dev libxtst-dev libgl1-mesa-dev libegl1-mesa-dev libwayland-dev libwayland-bin libgtk-3-dev libgdk-pixbuf2.0-dev libdbus-1-dev libpipewire-0.3-dev libpulse-dev libasound2-dev git
        # Build SDL3 from source
        cd /tmp
        git clone --depth 1 https://github.com/libsdl-org/SDL.git sdl3-build
        cd sdl3-build
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DSDL_SHARED=ON -DSDL_STATIC=OFF -DSDL_TESTS=OFF
        cmake --build . -j$(nproc)
        sudo cmake --install .
        # Build SDL3_ttf from source
        cd /tmp
        git clone --depth 1 https://github.com/libsdl-org/SDL_ttf.git sdl3-ttf-build
        cd sdl3-ttf-build
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DSDL3TTF_SHARED=ON -DSDL3TTF_STATIC=OFF
        cmake --build . -j$(nproc)
        sudo cmake --install .
        # Verify libraries are installed
        ls -la /usr/local/lib/libSDL3* || echo "SDL3 libraries not found in /usr/local/lib"
        sudo ldconfig
    
    - name: Install SDL3 (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install sdl3 sdl3_ttf
    
    - name: Build Release (Ubuntu)
      if: matrix.os == 'ubuntu-22.04'
      env:
        LIBRARY_PATH: /usr/local/lib
        LD_LIBRARY_PATH: /usr/local/lib
        PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
      run: |
        swift build -c release
    
    - name: Build Release (macOS)
      if: matrix.os == 'macos-latest'
      env:
        LIBRARY_PATH: /opt/homebrew/lib:/usr/local/lib
      run: |
        swift build -c release
    
    - name: Setup MSBuild (Windows)
      if: matrix.os == 'windows-latest'
      uses: microsoft/setup-msbuild@v1.3.1
    
    - name: Build SDL3 Static (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        # Install CMake if not available
        if (-not (Get-Command cmake -ErrorAction SilentlyContinue)) {
          Write-Host "CMake not found, installing via winget..."
          winget install --id Kitware.CMake -e --silent --accept-package-agreements --accept-source-agreements
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        }
        # Build SDL3 as static library
        cd $env:TEMP
        git clone --depth 1 https://github.com/libsdl-org/SDL.git sdl3-static-build
        cd sdl3-static-build
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DSDL_SHARED=OFF -DSDL_STATIC=ON -DSDL_TESTS=OFF
        cmake --build . --config Release
        # Try to find the library in build output (Visual Studio puts it in Release/ subdirectory)
        $sdl3Lib = $null
        # First, try to find in the build output directory
        $buildOutputDirs = @("Release", "Release\lib", "lib", ".")
        foreach ($dir in $buildOutputDirs) {
          $searchPath = Join-Path $PWD $dir
          if (Test-Path $searchPath) {
            $found = Get-ChildItem "$searchPath\*.lib" -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "^SDL3" -and $_.Name -notmatch "SDL3_ttf" -and $_.Name -notmatch "\.dll\.lib$" } | Select-Object -First 1
            if ($found) {
              $sdl3Lib = $found
              Write-Host "Found SDL3 library in build output: $($found.FullName)"
              break
            }
          }
        }
        # If not found in build output, try install (but don't fail if it fails)
        if (-not $sdl3Lib) {
          $sdl3InstallPath = "$env:TEMP\sdl3-static"
          New-Item -ItemType Directory -Force -Path $sdl3InstallPath | Out-Null
          cmake --install . --config Release --prefix $sdl3InstallPath 2>&1 | Out-Null
          if (Test-Path "$sdl3InstallPath\lib") {
            $sdl3Lib = Get-ChildItem "$sdl3InstallPath\lib\*.lib" -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "^SDL3" -and $_.Name -notmatch "SDL3_ttf" } | Select-Object -First 1
          }
        }
        # Copy to project root with standard name
        if ($sdl3Lib) {
          Copy-Item $sdl3Lib.FullName "$env:GITHUB_WORKSPACE\SDL3.lib" -Force
          Write-Host "Copied and renamed $($sdl3Lib.Name) to SDL3.lib"
        } else {
          Write-Host "Error: SDL3 static library not found after build"
          Write-Host "Searching in: $PWD"
          Get-ChildItem -Recurse -Filter "*.lib" | Select-Object FullName | ForEach-Object { Write-Host "Found lib: $($_.FullName)" }
          exit 1
        }
        # Copy headers (try install path first, then source directory)
        New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\sdl3-headers" | Out-Null
        $headerSource = "$sdl3InstallPath\include\SDL3"
        if (-not (Test-Path $headerSource)) {
          # Try source directory
          $headerSource = "$env:TEMP\sdl3-static-build\include\SDL3"
        }
        if (Test-Path $headerSource) {
          Copy-Item "$headerSource\*" "$env:GITHUB_WORKSPACE\sdl3-headers\" -Recurse -ErrorAction SilentlyContinue
          Write-Host "Copied SDL3 headers from $headerSource"
        } else {
          Write-Host "Warning: SDL3 headers not found"
        }
        Write-Host "SDL3 static library built and installed"
    
    - name: Build SDL3_ttf Static (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        # Build SDL3_ttf as static library
        cd $env:TEMP
        git clone --depth 1 https://github.com/libsdl-org/SDL_ttf.git sdl3-ttf-static-build
        cd sdl3-ttf-static-build
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        # Find SDL3 installation (point to the build directory where SDL3Config.cmake is)
        $sdl3BuildPath = "$env:TEMP\sdl3-static-build\build"
        # SDL3_ttf will find freetype automatically or we can let CMake download it
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DSDL3TTF_SHARED=OFF -DSDL3TTF_STATIC=ON -DSDL3_DIR="$sdl3BuildPath"
        cmake --build . --config Release
        # Try to find the library in build output (Visual Studio puts it in Release/ subdirectory)
        $sdl3ttfLib = $null
        # First, try to find in the build output directory
        $buildOutputDirs = @("Release", "Release\lib", "lib", ".")
        foreach ($dir in $buildOutputDirs) {
          $searchPath = Join-Path $PWD $dir
          if (Test-Path $searchPath) {
            $found = Get-ChildItem "$searchPath\*.lib" -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "SDL3_ttf" -and $_.Name -notmatch "\.dll\.lib$" } | Select-Object -First 1
            if ($found) {
              $sdl3ttfLib = $found
              Write-Host "Found SDL3_ttf library in build output: $($found.FullName)"
              break
            }
          }
        }
        # If not found in build output, try install (but don't fail if it fails)
        if (-not $sdl3ttfLib) {
          $sdl3ttfInstallPath = "$env:TEMP\sdl3-ttf-static"
          New-Item -ItemType Directory -Force -Path $sdl3ttfInstallPath | Out-Null
          cmake --install . --config Release --prefix $sdl3ttfInstallPath 2>&1 | Out-Null
          if (Test-Path "$sdl3ttfInstallPath\lib") {
            $sdl3ttfLib = Get-ChildItem "$sdl3ttfInstallPath\lib\*.lib" -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "SDL3_ttf" } | Select-Object -First 1
          }
        }
        # Copy to project root with standard name
        if ($sdl3ttfLib) {
          Copy-Item $sdl3ttfLib.FullName "$env:GITHUB_WORKSPACE\SDL3_ttf.lib" -Force
          Write-Host "Copied and renamed $($sdl3ttfLib.Name) to SDL3_ttf.lib"
        } else {
          Write-Host "Error: SDL3_ttf static library not found after build"
          Write-Host "Searching in: $PWD"
          Get-ChildItem -Recurse -Filter "*.lib" | Select-Object FullName | ForEach-Object { Write-Host "Found lib: $($_.FullName)" }
          exit 1
        }
        Write-Host "SDL3_ttf static library built and installed"
    
    - name: Build Release (Windows)
      if: matrix.os == 'windows-latest'
      shell: cmd
      run: |
        swift build -c release
    
    - name: Bundle Windows Release (Windows)
      if: matrix.os == 'windows-latest' && github.event_name == 'push'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release-bundle | Out-Null
        Copy-Item .build\release\Tetrix.exe release-bundle\
        # SDL3 and SDL3_ttf are now statically linked, so no DLLs needed
        # Only copy Swift runtime DLLs (these cannot be statically linked)
        $swiftDlls = @("swiftCore.dll", "swiftWinSDK.dll", "FoundationEssentials.dll", "swiftCRT.dll")
        $swiftPath = "$env:LOCALAPPDATA\Programs\Swift"
        foreach ($dll in $swiftDlls) {
          $found = Get-ChildItem -Path $swiftPath -Filter $dll -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($found) {
            Copy-Item $found.FullName release-bundle\
            Write-Host "Copied $dll from $($found.FullName)"
          } else {
            Write-Host "Warning: $dll not found"
          }
        }
        Compress-Archive -Path release-bundle\* -DestinationPath Tetrix-windows.zip -Force
    
    - name: Rename macOS Binary
      if: matrix.os == 'macos-latest' && github.event_name == 'push'
      run: |
        if [ -f .build/release/Tetrix ]; then
          mv .build/release/Tetrix .build/release/TetrixDarwin
          echo "Renamed Tetrix to TetrixDarwin"
        else
          echo "Error: .build/release/Tetrix not found"
          ls -la .build/release/ || echo "Release directory does not exist"
          exit 1
        fi
    
    - name: Delete Existing Release (Linux - first platform)
      if: matrix.os == 'ubuntu-22.04' && github.event_name == 'push'
      run: |
        gh release delete latest --yes || echo "Release 'latest' does not exist, will create new one"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create/Update Release and Upload Asset (Linux)
      if: matrix.os == 'ubuntu-22.04' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        target_commitish: ${{ github.sha }}
        name: Latest Build
        draft: false
        prerelease: false
        generate_release_notes: true
        files: .build/release/Tetrix
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Verify macOS Binary Before Upload
      if: matrix.os == 'macos-latest' && github.event_name == 'push'
      run: |
        if [ ! -f .build/release/TetrixDarwin ]; then
          echo "Error: TetrixDarwin binary not found after rename"
          ls -la .build/release/ || echo "Release directory does not exist"
          exit 1
        fi
        echo "TetrixDarwin binary found, size: $(stat -f%z .build/release/TetrixDarwin 2>/dev/null || stat -c%s .build/release/TetrixDarwin 2>/dev/null || echo 'unknown') bytes"
    
    - name: Create/Update Release and Upload Asset (macOS)
      if: matrix.os == 'macos-latest' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        target_commitish: ${{ github.sha }}
        name: Latest Build
        draft: false
        prerelease: false
        generate_release_notes: true
        files: .build/release/TetrixDarwin
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create/Update Release and Upload Asset (Windows)
      if: matrix.os == 'windows-latest' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        target_commitish: ${{ github.sha }}
        name: Latest Build
        draft: false
        prerelease: false
        generate_release_notes: true
        files: Tetrix-windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
